
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>DPVI for arbitrary parametric models: Twinify usage example &#8212; Twinify</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Public API: Twinify package" href="../api.html" />
    <link rel="prev" title="Napsu-MQ for categorical data: Twinify usage example" href="NapsuMQ%20example.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/PeopleAfter.jpg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Twinify</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../quickstart.html">
   Getting started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../cli_doc.html">
   Command line interface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api_usage.html">
   API Overview
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../examples.html">
   Examples
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="NapsuMQ%20example.html">
     Napsu-MQ for categorical data: Twinify usage example
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     DPVI for arbitrary parametric models: Twinify usage example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../api.html">
   Public API: Twinify package
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../api/base.html">
     twinify.base package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../api/dpvi.html">
     twinify.dpvi package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../api/napsu_mq.html">
     twinify.napsu_mq package
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../faq.html">
   FAQ
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about_us.html">
   About us
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../acknowledgements.html">
   Acknowledgements
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/DPBayes/twinify"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/DPBayes/twinify/issues/new?title=Issue%20on%20page%20%2F_examples/DPVI example.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/_examples/DPVI example.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generating-an-example-data-set">
   Generating an example data set
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-numpyro-model-function">
   Creating a NumPyro model function
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#learning-the-model-s-parameters-with-privacy-guarantees">
   Learning the Model’s Parameters with Privacy Guarantees
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sampling-synthetic-data">
   Sampling Synthetic Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparing-the-synthetic-data-to-the-original-data">
   Comparing the Synthetic Data to the Original Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#storing-and-loading-the-learned-model">
   Storing and Loading the Learned Model
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>DPVI for arbitrary parametric models: Twinify usage example</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generating-an-example-data-set">
   Generating an example data set
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-numpyro-model-function">
   Creating a NumPyro model function
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#learning-the-model-s-parameters-with-privacy-guarantees">
   Learning the Model’s Parameters with Privacy Guarantees
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sampling-synthetic-data">
   Sampling Synthetic Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparing-the-synthetic-data-to-the-original-data">
   Comparing the Synthetic Data to the Original Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#storing-and-loading-the-learned-model">
   Storing and Loading the Learned Model
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="dpvi-for-arbitrary-parametric-models-twinify-usage-example">
<h1>DPVI for arbitrary parametric models: Twinify usage example<a class="headerlink" href="#dpvi-for-arbitrary-parametric-models-twinify-usage-example" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>

<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">d3p</span>
<span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="k">as</span> <span class="nn">dists</span>
<span class="kn">from</span> <span class="nn">twinify.dpvi</span> <span class="kn">import</span> <span class="n">DPVIModel</span><span class="p">,</span> <span class="n">DPVIResult</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">twinify.dpvi.modelling</span> <span class="kn">import</span> <span class="n">slice_feature</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
</pre></div>
</div>
</div>
</div>
<section id="generating-an-example-data-set">
<h2>Generating an example data set<a class="headerlink" href="#generating-an-example-data-set" title="Permalink to this headline">#</a></h2>
<p>We first generate a simple data set of size <span class="math notranslate nohighlight">\(N\)</span> where each data point <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> is sampled from a mixture of one of two Gaussians, depending on a known indicator variable <span class="math notranslate nohighlight">\(z\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set up some mean and covariances for the two Gaussians that make up the mixture</span>
<span class="n">num_dims</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]</span>
<span class="p">])</span>
<span class="n">covariances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mf">.6</span><span class="p">,</span> <span class="mf">.4</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">.4</span><span class="p">,</span> <span class="mf">.9</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">])</span>
<span class="n">chol_covariances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariances</span><span class="p">])</span>

<span class="n">center_sample_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">200</span><span class="p">,</span> <span class="mi">800</span><span class="p">])</span>
<span class="n">assignments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">center_sample_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">center_sample_counts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)))</span>
<span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">826935</span><span class="p">)</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">center_sample_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">num_dims</span><span class="p">)</span> 

<span class="n">xs</span><span class="p">[:</span><span class="n">center_sample_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[:</span><span class="n">center_sample_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">@</span> <span class="n">chol_covariances</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">xs</span><span class="p">[</span><span class="n">center_sample_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">center_sample_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span> <span class="o">@</span> <span class="n">chol_covariances</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">orig_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;first_dimension&quot;</span><span class="p">,</span> <span class="s2">&quot;second_dimension&quot;</span><span class="p">])</span>
<span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assignments</span>
<span class="n">orig_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>first_dimension</th>
      <th>second_dimension</th>
      <th>assignments</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-4.190167</td>
      <td>-3.666270</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-1.294340</td>
      <td>-2.099514</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-1.078206</td>
      <td>-1.104915</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-2.576338</td>
      <td>-0.579721</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-3.374816</td>
      <td>-2.171204</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>995</th>
      <td>2.333329</td>
      <td>0.871575</td>
      <td>1</td>
    </tr>
    <tr>
      <th>996</th>
      <td>-0.182534</td>
      <td>-0.388142</td>
      <td>1</td>
    </tr>
    <tr>
      <th>997</th>
      <td>0.481779</td>
      <td>-0.595240</td>
      <td>1</td>
    </tr>
    <tr>
      <th>998</th>
      <td>0.928569</td>
      <td>1.943616</td>
      <td>1</td>
    </tr>
    <tr>
      <th>999</th>
      <td>2.614884</td>
      <td>0.737531</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>1000 rows × 3 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;first_dimension&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;second_dimension&#39;</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2e8ab831d7b91ae3cfc764c0384697699cbb447a8a8b7b0f60b62a893fc6456b.png" src="../_images/2e8ab831d7b91ae3cfc764c0384697699cbb447a8a8b7b0f60b62a893fc6456b.png" />
</div>
</div>
</section>
<section id="creating-a-numpyro-model-function">
<h2>Creating a NumPyro model function<a class="headerlink" href="#creating-a-numpyro-model-function" title="Permalink to this headline">#</a></h2>
<p>For twinify’s DPVI mode, we now need to specify a probabilistic model, which will be fit to the data and which we can later use to generate the synthetic twin. We need to specify join distribution over parameters and observations, which we split into a parameter prior <span class="math notranslate nohighlight">\(p(\mathbf{\theta})\)</span> and a data likelihood conditioned on parameter values <span class="math notranslate nohighlight">\(p(\mathbf{x},z|\mathbf{\theta})\)</span>. The likelihood part follows exactly the mixture model we used to generate the example data above:</p>
<p><span class="math notranslate nohighlight">\( p(\mathbf{x},z|\theta) = p(z=0|\pi) \mathcal{N}(\mathbf{x}|\mu_0, \Sigma_0) + p(z=1|\pi) \mathcal{N}(\mathbf{x}|\mu_1, \Sigma_1). \)</span></p>
<p>Additionally, we define the following prior:</p>
<p><span class="math notranslate nohighlight">\( \pi \sim \text{Beta}(1, 1), \)</span></p>
<p><span class="math notranslate nohighlight">\( \mathbf{\mu}_i \sim \mathcal{N}(0, \mathbf{I}_2), \)</span></p>
<p><span class="math notranslate nohighlight">\( \Sigma_i = \mathbf{s}_i C_i \text{, where } \mathbf{s}_i \sim \Gamma(1), C_i \sim \text{LKJ}(2, 1.). \)</span></p>
<p>Below is this model expressed as a NumPyro model function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">xs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_obs_total</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Model function; specifies the joint distribution of parameters and observations.</span>

<span class="sd">    Args:</span>
<span class="sd">        xs (jax.numpy.ndarray): A batch of observations / training data during inference. None during data generation.</span>
<span class="sd">        num_obs_total (int): The size of the training data set during inference. None during data generation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">xs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">xs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">num_obs_total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_obs_total</span> <span class="o">=</span> <span class="n">batch_size</span>

    <span class="n">num_mixture_components</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># prior</span>
    <span class="n">assignment_probability</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;assignment_p&quot;</span><span class="p">,</span> <span class="n">dists</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
    <span class="n">component_correlations</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;correlations&quot;</span><span class="p">,</span> <span class="n">dists</span><span class="o">.</span><span class="n">LKJCholesky</span><span class="p">(</span><span class="n">num_dims</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_mixture_components</span><span class="p">,))</span>
    <span class="n">component_marginal_stddevs</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;stddevs&quot;</span><span class="p">,</span> <span class="n">dists</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_mixture_components</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">))</span>
    <span class="n">component_means</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;means&quot;</span><span class="p">,</span> <span class="n">dists</span><span class="o">.</span><span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dims</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_dims</span><span class="p">)),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_mixture_components</span><span class="p">,))</span>

    <span class="n">component_scale_tril</span> <span class="o">=</span> <span class="n">component_marginal_stddevs</span> <span class="o">*</span> <span class="n">component_correlations</span>

    <span class="c1"># likelihood</span>
    <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;observations&quot;</span><span class="p">,</span> <span class="n">num_obs_total</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">xs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assignments</span> <span class="o">=</span> <span class="n">slice_feature</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">assignments</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">assignments</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;assignment&quot;</span><span class="p">,</span> <span class="n">dists</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">assignment_probability</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">assignments</span><span class="p">)</span>

        <span class="c1"># the input parameter xs contains the variables x and z of our model, laid out as [x dim 0, x dim 1, z].</span>
        <span class="c1"># twinify&#39;s slice_features method allows us to extract only the two dimensions corresponding to variable x.</span>
        <span class="c1"># Compared to manual slicing, slice_features deals gracefully with the case that xs may be None during data generation.</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;xs&quot;</span><span class="p">,</span>
                            <span class="n">dists</span><span class="o">.</span><span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">component_means</span><span class="p">[</span><span class="n">assignments</span><span class="p">],</span> <span class="n">scale_tril</span><span class="o">=</span><span class="n">component_scale_tril</span><span class="p">[</span><span class="n">assignments</span><span class="p">]),</span>
                            <span class="n">obs</span><span class="o">=</span><span class="n">slice_feature</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># As opposed to regular NumPyro models, twinify expects model functions to return the generated data as a single array</span>
    <span class="c1"># with the same layout as the input.</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">xs</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="learning-the-model-s-parameters-with-privacy-guarantees">
<h2>Learning the Model’s Parameters with Privacy Guarantees<a class="headerlink" href="#learning-the-model-s-parameters-with-privacy-guarantees" title="Permalink to this headline">#</a></h2>
<p>With our model function now defined, we create a <code class="docutils literal notranslate"><span class="pre">DPVIModel</span></code> class from it and invoke the privacy-preserving inference with privacy parameters <span class="math notranslate nohighlight">\(\epsilon = 2\)</span> and <span class="math notranslate nohighlight">\(\delta = 1/N^2\)</span>. The inference requires a key to extract randomness from as the second argument, which we construct using <code class="docutils literal notranslate"><span class="pre">d3p.random.PRNGKey()</span></code> without arguments, which obtains a secure random key from the system (using the <code class="docutils literal notranslate"><span class="pre">secrets</span></code> module).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dpvi_model</span> <span class="o">=</span> <span class="n">DPVIModel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">dpvi_posterior</span> <span class="o">=</span> <span class="n">dpvi_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">orig_df</span><span class="p">,</span> <span class="n">d3p</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(),</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">orig_df</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epochs: 100%|██████████████████████████████████████████████████████████████████████████████████████| 1000/1000 [00:13&lt;00:00, 73.62it/s, ELBO 3.842]
</pre></div>
</div>
</div>
</div>
</section>
<section id="sampling-synthetic-data">
<h2>Sampling Synthetic Data<a class="headerlink" href="#sampling-synthetic-data" title="Permalink to this headline">#</a></h2>
<p>We have obtained a distribution over model parameters, wrapped handily in a <code class="docutils literal notranslate"><span class="pre">DPVIResult</span></code> object. This allows us to easily sample a new data set that will follow the same distribution as the original data. This method also requires a randomness key. Here we provide a seed to <code class="docutils literal notranslate"><span class="pre">d3p.random.PRNGKey(1)</span></code> which allows us to reproduce the draw of random data from the model if we should require to later on (by providing the same key again).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syn_data</span> <span class="o">=</span> <span class="n">dpvi_posterior</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">d3p</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">syn_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>first_dimension</th>
      <th>second_dimension</th>
      <th>assignments</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2.721477</td>
      <td>1.458468</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.681876</td>
      <td>1.440651</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.470739</td>
      <td>0.387443</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.646680</td>
      <td>0.657080</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.060938</td>
      <td>1.124412</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>995</th>
      <td>1.365926</td>
      <td>1.313087</td>
      <td>1</td>
    </tr>
    <tr>
      <th>996</th>
      <td>0.154217</td>
      <td>-0.214150</td>
      <td>1</td>
    </tr>
    <tr>
      <th>997</th>
      <td>-2.854531</td>
      <td>-2.953636</td>
      <td>0</td>
    </tr>
    <tr>
      <th>998</th>
      <td>0.911147</td>
      <td>0.972202</td>
      <td>1</td>
    </tr>
    <tr>
      <th>999</th>
      <td>0.789635</td>
      <td>1.365873</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>1000 rows × 3 columns</p>
</div></div></div>
</div>
</section>
<section id="comparing-the-synthetic-data-to-the-original-data">
<h2>Comparing the Synthetic Data to the Original Data<a class="headerlink" href="#comparing-the-synthetic-data-to-the-original-data" title="Permalink to this headline">#</a></h2>
<p>We perform a quick visual exploration of the quality of the synthetic data by first plotting a scatter plot overlaid on that of the original data, which shows that the synthetic data is indeed following the distribution of the original data closely.</p>
<p>We also plot the number of data points assigned to each cluster further below and verify that they match between synthetic (crosses) and original data (points).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;first_dimension&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;second_dimension&#39;</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">syn_data</span><span class="p">[</span><span class="s1">&#39;first_dimension&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">syn_data</span><span class="p">[</span><span class="s1">&#39;second_dimension&#39;</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="n">syn_data</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/664d1c3d34181e5c428389fe6c181b4b1c85bfe56a5d2324597d2b811b453fba.png" src="../_images/664d1c3d34181e5c428389fe6c181b4b1c85bfe56a5d2324597d2b811b453fba.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">component_assignments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;assignments&#39;</span><span class="p">:</span> <span class="n">orig_df</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">],</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;orig&#39;</span><span class="p">}),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;assignments&#39;</span><span class="p">:</span> <span class="n">syn_data</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">],</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;syn&#39;</span><span class="p">})</span>
<span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">component_assignments</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;assignments&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="s1">&#39;dodge&#39;</span><span class="p">,</span> <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9ed0b9105b603ef5e7e0d9c45adfa4819fff3629fce6c30f915a1a14286409ba.png" src="../_images/9ed0b9105b603ef5e7e0d9c45adfa4819fff3629fce6c30f915a1a14286409ba.png" />
</div>
</div>
</section>
<section id="storing-and-loading-the-learned-model">
<h2>Storing and Loading the Learned Model<a class="headerlink" href="#storing-and-loading-the-learned-model" title="Permalink to this headline">#</a></h2>
<p>twinify enables us to store the inferred parameters for later use. However, as the model function as such cannot be easily persisted, it is the user’s responsibility to make it available during loading of the model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dpvi_posterior</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="s2">&quot;twinify_result&quot;</span><span class="p">)</span>
<span class="n">loaded_posterior</span> <span class="o">=</span> <span class="n">DPVIResult</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;twinify_result&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>

<span class="c1"># with the loaded model we can again generate data; using the same randomness as before, we can re-produce the same data set</span>
<span class="n">syn_data_from_loaded_posterior</span> <span class="o">=</span> <span class="n">loaded_posterior</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">d3p</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">syn_data_from_loaded_posterior</span> <span class="o">==</span> <span class="n">syn_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="NapsuMQ%20example.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Napsu-MQ for categorical data: Twinify usage example</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../api.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Public API: Twinify package</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By twinify Developers<br/>
  
      &copy; Copyright 2023, twinify Developers and their assignees.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>